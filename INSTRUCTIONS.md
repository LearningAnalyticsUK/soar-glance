## Glance evaluation setup

1. Create Postgres database with correct details using the following two commands:
    ```
    psql -c 'create user postgres createdb'
    psql -c 'create database glance_eval' -U postgres
    ```

2. Download and extract datafiles from provided NCL Dropoff link.

3. Start the `sbt` console in the `soar` directory by executing the `sbt` command.

4. Once the sbt console has started, generate the database schema using the following command: 
    ```
    glance-evalJVM/flywayMigrate
    ``` 
    
5. Unfortunately the prepackaged versions of the cli tools are failing silently at the moment. I'm figuring out why as 
 we speak, but in the mean time run the `transform` job (which prepares sql12 data for insertion into the glance 
 database) using the following command in sbt: 
    ```
    glance-eval-cli/run transform -c /Location/Of/CSClusterSessions.csv -r /Location/Of/RecapSessions.csv -m /Location/Of/NessMarks.csv -o /Directory/To/Write/Transformed/Csvs -p CSC -y 2015 -s 2
    ``` 
    
6. Run the `generate` job (which creates the surveys in the glance database) using the following command in sbt:
    ```
    glance-eval-cli/run generate -i /Location/Of/marks.csv --modules CSC3621,CSC3222,CSC2026
    ```
    **Note** that `marks.csv` is generated by the previous job.
    
7. Run `load-support` job (which loads cluster and recap info transformed by step 5, into the glance database) using the
following command in sbt: 
    ```
    glance-eval-cli/run load-support -c /Location/Of/clusterSessions.csv -r /Location/Of/recapSessions.csv
    ```
    **Note** that `clusterSessions.csv` and `recapSessions.csv` are generated by the `transform` job.

8. Exit the `sbt` console and manually execute .sql dump in `glance-eval-cli/cs-surveys-bin` against the glance 
postgres database. This loads module titles, descriptions, keywords, and start dates/durations (where needed).

9. Restart the sbt console (using `sbt`).

10. Start the survey app with the following command:
    ```
    glance-evalJVM/reStart
    ``` 
    Once you have done this, the api is available [here](http://localhost:8080), whilst the front-end is available  
    [here](http://localhost:12345/glance-eval/js/target/scala-2.11/classes/index-dev.html).


### Updating (no data changes)

1. Pull down the soar repo
2. re-run `glance-evalJVM/flyWayMigrate` 
3. Perform steps 8-9 above.

### Updating (data changes)
1. Pull down the soar repo
2. Backup database with the `pg_dump` utility or similar
3. Run `glance-evalJVM/flywayClean` then `glance-evalJVM/flywayMigrate`. **Note** that the clean command will wipe the 
database.
4. Rerun steps 4-9 above. 


